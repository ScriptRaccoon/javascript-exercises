<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Knight's Tour - Visualization</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				background-color: #222;
				color: white;
				font-family: Arial, Helvetica, sans-serif;
				min-height: 100vh;
				display: flex;
				justify-content: center;
				align-items: center;
				padding: 1rem;
			}

			.board {
				display: grid;
				width: min-content;
				grid-template-columns: repeat(var(--m), 1fr);
				grid-template-rows: repeat(var(--n), 1fr);
				border: 0.75rem solid rgb(62, 28, 8);
				border-radius: 0.25rem;
				box-shadow: 0 0 5rem #fff2;
				--unit: 3rem;
			}

			.square {
				width: var(--unit);
				aspect-ratio: 1;
				transition: background-color 100ms;
			}

			.square.light {
				background-color: hsl(47, 62%, 68%);
			}

			.square.light.visited {
				background-color: hsl(47, 0%, 68%);
			}

			.square.dark {
				background-color: hsl(22, 73%, 24%);
			}

			.square.dark.visited {
				background-color: hsl(22, 0%, 24%);
			}

			.piece {
				width: calc(0.7 * var(--unit));
				position: absolute;
				transform: translate(
						calc((var(--x, 0) + 0.5) * var(--unit)),
						calc((var(--y, 0) + 0.5) * var(--unit))
					)
					translate(-50%, -50%);

				transition: transform var(--speed) ease-out;
			}
		</style>
	</head>
	<body>
		<div class="board">
			<div class="piece">
				<!-- knight piece SVG -->
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 642.11 632.33">
					<g transform="translate(-50.977 -210)">
						<g transform="matrix(11.229,0,0,11.229,12.707,166.84)">
							<path
								style="
									stroke-linejoin: round;
									stroke: #000;
									stroke-width: 2;
									stroke-linecap: round;
									fill: #000;
								"
								d="m34.904 23.969c0.3125 3.9688-2.1562 8.7188-10.75 11.375-6.4688 3.0312-8.2812 11.375-11.625 11.75-0.44869-0.63344-3.7574-0.29677 0.15008-5.0396-3.8586 4.6859-9.138 0.54576-8.1501-3.5854 0.5-5.5 6.875-10.406 7.375-14.5-2-5.3438 4.5-9.875 4.5-9.875l0.125-8.75 8 4.5 4.25-5 3.25 6.875c25-4.75 26.469 35.688 27.562 47.375l-39.688 0.0625c-2.1875-9.0625 13.188-14.312 11.75-27.562m-7.125-21.75-7.625 4"
							/>
							<path
								d="m72.09 13.334c0.77278-0.93619 2.0182-0.9462 2.8011-0.02252 0.78284 0.92368 0.81496 2.4411 0.07224 3.4128-0.74273 0.97164-1.987 1.0399-2.7983 0.15352-0.81136-0.88638-0.89123-2.4012-0.17965-3.4069"
								style="fill: #fff"
								transform="matrix(.51974 .21576 -.3834 .92358 -15.897 -8.6131)"
							/>
							<path
								d="m72.09 13.334c0.77278-0.93619 2.0182-0.9462 2.8011-0.02252 0.78284 0.92368 0.81496 2.4411 0.07224 3.4128-0.74273 0.97164-1.987 1.0399-2.7983 0.15352-0.81136-0.88638-0.89123-2.4012-0.17965-3.4069"
								style="fill: #fff"
								transform="matrix(.51974 .21576 -.3834 .92358 -23.897 10.137)"
							/>
						</g>
					</g>
				</svg>
			</div>
		</div>

		<script>
			function find_knight_tour(n, m, start) {
				const matrix = Array.from({ length: n }, () => Array(m).fill(0))

				const mark_step = ([y, x], step) => {
					matrix[y][x] = step
				}

				const is_visited = ([y, x]) => matrix[y][x] >= 1

				const is_valid = ([y, x]) => y >= 0 && y < n && x >= 0 && x < m

				const get_next_coords = ([y, x]) => {
					const coords = []
					for (const u of [1, -1]) {
						for (const v of [2, -2]) {
							for (const flipped of [true, false]) {
								const coord = flipped ? [y + v, x + u] : [y + u, x + v]
								if (is_valid(coord) && !is_visited(coord)) {
									coords.push(coord)
								}
							}
						}
					}
					return coords
				}

				function solve(current, step) {
					mark_step(current, step)

					if (step === n * m) return matrix

					const next_coords = get_next_coords(current)

					const next_coords_with_counts = next_coords.map((coord) => [
						coord,
						get_next_coords(coord).length,
					])
					next_coords_with_counts.sort((a, b) => a[1] - b[1])

					for (const [coord] of next_coords_with_counts) {
						const solution = solve(coord, step + 1)
						if (solution) return solution
					}

					mark_step(current, 0)

					return null
				}

				return solve(start, 1)
			}

			function get_tour_coords(matrix) {
				const coords = []
				for (let y = 0; y < matrix.length; y++) {
					for (let x = 0; x < matrix[0].length; x++) {
						const n = matrix[y][x]
						if (n === 0) continue
						coords[n - 1] = [y, x]
					}
				}
				return coords
			}

			function create_board(n, m) {
				const board = document.querySelector(".board")
				board.style.setProperty("--n", n)
				board.style.setProperty("--m", m)

				for (let y = 0; y < n; y++) {
					for (let x = 0; x < m; x++) {
						const square = document.createElement("div")
						square.classList.add("square")
						square.classList.add((x + y) % 2 === 0 ? "light" : "dark")
						square.id = `square_${y},${x}`
						board.appendChild(square)
					}
				}

				return board
			}

			function animate_tour(n, m, start, options) {
				const board = create_board(n, m)

				const matrix = find_knight_tour(n, m, start)
				if (!matrix) return

				const tour = get_tour_coords(matrix)

				const { speed, wait, initial_wait } = options

				const piece = document.querySelector(".piece")
				if (!piece) return

				piece.style.setProperty("--speed", `${speed}ms`)

				go_to_square(0)

				function go_to_square(i) {
					if (i === tour.length) return

					const coord = tour[i]
					const [y, x] = coord
					piece.style.setProperty("--x", x)
					piece.style.setProperty("--y", y)

					setTimeout(() => {
						document
							.getElementById(`square_${y},${x}`)
							?.classList.add("visited")
					}, speed)

					setTimeout(
						() => {
							go_to_square(i + 1)
						},
						speed + wait + (i === 0 ? initial_wait : 0),
					)
				}
			}

			animate_tour(10, 10, [0, 0], { speed: 180, wait: 300, initial_wait: 2000 })
		</script>
	</body>
</html>
